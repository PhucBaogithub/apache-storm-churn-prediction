<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Prediction Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .simple-border {
            border: 1px solid #e5e7eb;
        }
        
        .log-output {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-output::-webkit-scrollbar-track {
            background: #f9fafb;
        }
        
        .log-output::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="h-full bg-white text-gray-900" x-data="churnApp()">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Churn Prediction Dashboard</h1>
                    <p class="text-gray-600">Apache Storm + Machine Learning</p>
                </div>
                <div class="simple-border rounded-lg px-4 py-2">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-gray-700 text-sm font-medium">System Active</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Processed Records</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.total_processed">0</p>
                </div>
            </div>

            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Predictions Made</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.total_predictions">0</p>
                </div>
            </div>

            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Churn Rate</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.churn_rate + '%'">0%</p>
                </div>
            </div>

            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Model Accuracy</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.accuracy + '%'">80%</p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Prediction Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg simple-border overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Dự đoán Churn</h3>
                    </div>
                    <div class="p-6">
                        <form @submit.prevent="makePrediction()" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Tổng tiền đã thanh toán
                                </label>
                                <input 
                                    type="number" 
                                    x-model="form.total_charges"
                                    step="0.01"
                                    min="0"
                                    max="10000"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                                    placeholder="Nhập tổng tiền..."
                                    required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Chi phí hàng tháng
                                </label>
                                <input 
                                    type="number" 
                                    x-model="form.monthly_charges"
                                    step="0.01"
                                    min="0"
                                    max="200"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                                    placeholder="Nhập chi phí hàng tháng..."
                                    required>
                            </div>

                            <button 
                                type="submit"
                                :disabled="loading"
                                class="w-full bg-gray-900 text-white py-3 px-6 rounded-lg font-medium hover:bg-gray-800 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!loading">Dự đoán</span>
                                <span x-show="loading">Đang xử lý...</span>
                            </button>
                        </form>

                        <!-- Prediction Result -->
                        <div x-show="predictionResult" class="mt-6">
                            <div class="bg-gray-50 rounded-lg p-4 simple-border">
                                <h4 class="font-semibold text-gray-800 mb-3">Kết quả dự đoán:</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Trạng thái:</span>
                                        <span x-text="predictionResult.churn_status" 
                                              :class="predictionResult.prediction === 1 ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Xác suất:</span>
                                        <span x-text="predictionResult.probability + '%'" class="font-semibold text-gray-900"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Độ tin cậy:</span>
                                        <span x-text="predictionResult.confidence" class="font-semibold text-gray-900"></span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2">
                                        <span x-text="predictionResult.timestamp"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Output Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg simple-border overflow-hidden h-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Log Output - Real-time Data</h3>
                        <div class="flex space-x-2">
                            <button 
                                @click="activeTab = 'processed'"
                                :class="activeTab === 'processed' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Processed Data
                            </button>
                            <button 
                                @click="activeTab = 'predictions'"
                                :class="activeTab === 'predictions' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Predictions
                            </button>
                        </div>
                    </div>

                    <div class="p-6">
                        <!-- Auto-refresh toggle -->
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="autoRefresh" class="mr-2">
                                    <span class="text-sm text-gray-600">Auto-refresh (5s)</span>
                                </label>
                                <span x-show="lastUpdated" class="text-xs text-gray-500">
                                    Last updated: <span x-text="lastUpdated"></span>
                                </span>
                            </div>
                            <div class="flex space-x-2">
                                <button 
                                    @click="refreshData()"
                                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                                    Refresh
                                </button>
                                <button 
                                    @click="downloadData()"
                                    class="px-3 py-1 bg-gray-900 text-white rounded hover:bg-gray-800">
                                    Download
                                </button>
                            </div>
                        </div>

                        <!-- Data Table -->
                        <div class="log-output">
                            <div x-show="activeTab === 'processed'">
                                <h4 class="font-semibold text-gray-800 mb-3">
                                    Processed Records (<span x-text="processedData.length">0</span>)
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer ID</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Charges</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monthly Charges</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Churn</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="record in processedData" :key="record.customerID">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="record.customerID"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="parseFloat(record.TotalCharges).toFixed(2)"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="parseFloat(record.MonthlyCharges).toFixed(2)"></td>
                                                    <td class="px-4 py-2 text-sm">
                                                        <span :class="record.Churn === 'Yes' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                                              class="px-2 py-1 rounded-full text-xs font-medium" x-text="record.Churn"></span>
                                                    </td>
                                                    <td class="px-4 py-2 text-sm text-gray-500" x-text="record.processed_timestamp || record.processed_time"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div x-show="activeTab === 'predictions'">
                                <h4 class="font-semibold text-gray-800 mb-3">
                                    ML Predictions (<span x-text="predictionsData.length">0</span>)
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer ID</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Predicted</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Probability</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actual</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="record in predictionsData" :key="record.customerID">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="record.customerID"></td>
                                                    <td class="px-4 py-2 text-sm">
                                                        <span :class="record.Predicted_Churn === 1 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                                              class="px-2 py-1 rounded-full text-xs font-medium" 
                                                              x-text="record.Predicted_Churn === 1 ? 'Churn' : 'Stay'"></span>
                                                    </td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="(record.Probability * 100).toFixed(2) + '%'"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="record.Actual_Churn"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-500" x-text="record.prediction_timestamp || record.prediction_time"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        function churnApp() {
            return {
                // Data properties
                form: {
                    total_charges: '',
                    monthly_charges: ''
                },
                predictionResult: null,
                loading: false,
                stats: {
                    total_processed: 0,
                    total_predictions: 0,
                    churn_rate: 0,
                    accuracy: 80.0
                },
                processedData: [],
                predictionsData: [],
                activeTab: 'processed',
                autoRefresh: true,
                lastUpdated: null,
                refreshInterval: null,

                // Initialize
                init() {
                    this.loadStats();
                    this.refreshData();
                    this.startAutoRefresh();
                },

                // Make prediction
                async makePrediction() {
                    this.loading = true;
                    
                    try {
                        const response = await fetch('/api/predict', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.form)
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            this.predictionResult = data;
                            
                            // Refresh data after prediction
                            setTimeout(() => {
                                this.refreshData();
                                this.loadStats();
                            }, 1000);
                        } else {
                            alert('Lỗi: ' + data.error);
                        }
                    } catch (error) {
                        alert('Lỗi kết nối: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                // Load statistics
                async loadStats() {
                    try {
                        const response = await fetch('/api/stats');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.stats = data.stats;
                        }
                    } catch (error) {
                        console.error('Error loading stats:', error);
                    }
                },

                // Refresh data
                async refreshData() {
                    await Promise.all([
                        this.loadProcessedData(),
                        this.loadPredictionsData()
                    ]);
                    this.lastUpdated = new Date().toLocaleTimeString();
                },

                // Load processed data
                async loadProcessedData() {
                    try {
                        const response = await fetch('/api/data/processed');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.processedData = data.data.reverse(); // Show latest first
                        }
                    } catch (error) {
                        console.error('Error loading processed data:', error);
                    }
                },

                // Load predictions data
                async loadPredictionsData() {
                    try {
                        const response = await fetch('/api/data/predictions');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.predictionsData = data.data.reverse(); // Show latest first
                        }
                    } catch (error) {
                        console.error('Error loading predictions data:', error);
                    }
                },

                // Start auto refresh
                startAutoRefresh() {
                    this.refreshInterval = setInterval(() => {
                        if (this.autoRefresh) {
                            this.refreshData();
                            this.loadStats();
                        }
                    }, 5000); // Refresh every 5 seconds
                },

                // Download data
                downloadData() {
                    const dataType = this.activeTab === 'processed' ? 'processed' : 'predictions';
                    window.open(`/download/${dataType}`, '_blank');
                }
            }
        }
    </script>
</body>
</html> 