<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Prediction Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .simple-border {
            border: 1px solid #e5e7eb;
        }
        
        .log-output {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .log-output::-webkit-scrollbar-track {
            background: #f9fafb;
        }
        
        .log-output::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body class="h-full bg-white text-gray-900" x-data="churnApp()">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Churn Prediction Dashboard</h1>
                    <p class="text-gray-600">Apache Storm + Machine Learning</p>
                </div>
                <div class="simple-border rounded-lg px-4 py-2">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-gray-700 text-sm font-medium">System Active</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Processed Records</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.total_processed">0</p>
                </div>
            </div>

            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Predictions Made</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.total_predictions">0</p>
                </div>
            </div>

            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Churn Rate</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.churn_rate + '%'">0%</p>
                </div>
            </div>

            <div class="bg-white rounded-lg simple-border p-6">
                <div>
                    <p class="text-sm font-medium text-gray-600">Model Accuracy</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="stats.accuracy + '%'">80%</p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Prediction Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg simple-border overflow-hidden">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Dự đoán Churn</h3>
                    </div>
                    <div class="p-6">
                        <form @submit.prevent="makePrediction()" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Tổng tiền đã thanh toán
                                </label>
                                <input 
                                    type="number" 
                                    x-model="form.total_charges"
                                    step="0.01"
                                    min="0"
                                    max="10000"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                                    placeholder="Nhập tổng tiền..."
                                    required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Chi phí hàng tháng
                                </label>
                                <input 
                                    type="number" 
                                    x-model="form.monthly_charges"
                                    step="0.01"
                                    min="0"
                                    max="200"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                                    placeholder="Nhập chi phí hàng tháng..."
                                    required>
                            </div>

                            <button 
                                type="submit"
                                :disabled="loading"
                                class="w-full bg-gray-900 text-white py-3 px-6 rounded-lg font-medium hover:bg-gray-800 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!loading">Dự đoán</span>
                                <span x-show="loading">Đang xử lý...</span>
                            </button>
                        </form>

                        <!-- Prediction Result -->
                        <div x-show="predictionResult" class="mt-6">
                            <div class="bg-gray-50 rounded-lg p-4 simple-border">
                                <h4 class="font-semibold text-gray-800 mb-3">Kết quả dự đoán:</h4>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Trạng thái:</span>
                                        <span x-text="predictionResult.churn_status" 
                                              :class="predictionResult.prediction === 1 ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold'"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Xác suất:</span>
                                        <span x-text="predictionResult.probability + '%'" class="font-semibold text-gray-900"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Độ tin cậy:</span>
                                        <span x-text="predictionResult.confidence" class="font-semibold text-gray-900"></span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2">
                                        <span x-text="predictionResult.timestamp"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Output Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg simple-border overflow-hidden h-full">
                    <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Log Output - Real-time Data</h3>
                        <div class="flex space-x-2">
                            <button 
                                @click="activeTab = 'processed'"
                                :class="activeTab === 'processed' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Processed Data
                            </button>
                            <button 
                                @click="activeTab = 'predictions'"
                                :class="activeTab === 'predictions' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Predictions
                            </button>
                            <button 
                                @click="activeTab = 'statistics'"
                                :class="activeTab === 'statistics' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Statistics
                            </button>
                            <button 
                                @click="activeTab = 'search'"
                                :class="activeTab === 'search' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Customer Search
                            </button>
                            <button 
                                @click="activeTab = 'charts'"
                                :class="activeTab === 'charts' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Analytics Charts
                            </button>
                            <button 
                                @click="activeTab = 'filter'"
                                :class="activeTab === 'filter' ? 'bg-gray-900 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-3 py-1 rounded text-sm">
                                Advanced Filter
                            </button>
                        </div>
                    </div>

                    <div class="p-6">
                        <!-- Auto-refresh toggle -->
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" x-model="autoRefresh" class="mr-2">
                                    <span class="text-sm text-gray-600">Auto-refresh (5s)</span>
                                </label>
                                <span x-show="lastUpdated" class="text-xs text-gray-500">
                                    Last updated: <span x-text="lastUpdated"></span>
                                </span>
                            </div>
                            <div class="flex space-x-2">
                                <button 
                                    @click="refreshData()"
                                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                                    Refresh
                                </button>
                                <button 
                                    @click="downloadData()"
                                    class="px-3 py-1 bg-gray-900 text-white rounded hover:bg-gray-800">
                                    Download
                                </button>
                            </div>
                        </div>

                        <!-- Data Table -->
                        <div class="log-output">
                            <div x-show="activeTab === 'processed'">
                                <h4 class="font-semibold text-gray-800 mb-3">
                                    Processed Records (<span x-text="processedData.length">0</span>)
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer ID</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Charges</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monthly Charges</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Churn</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="record in processedData" :key="record.customerID">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="record.customerID"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="parseFloat(record.TotalCharges).toFixed(2)"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="parseFloat(record.MonthlyCharges).toFixed(2)"></td>
                                                    <td class="px-4 py-2 text-sm">
                                                        <span :class="record.Churn === 'Yes' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                                              class="px-2 py-1 rounded-full text-xs font-medium" x-text="record.Churn"></span>
                                                    </td>
                                                    <td class="px-4 py-2 text-sm text-gray-500" x-text="record.processed_timestamp || record.processed_time"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div x-show="activeTab === 'predictions'">
                                <h4 class="font-semibold text-gray-800 mb-3">
                                    ML Predictions (<span x-text="predictionsData.length">0</span>)
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer ID</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Predicted</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Probability</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actual</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="record in predictionsData" :key="record.customerID">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="record.customerID"></td>
                                                    <td class="px-4 py-2 text-sm">
                                                        <span :class="record.Predicted_Churn === 1 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                                              class="px-2 py-1 rounded-full text-xs font-medium" 
                                                              x-text="record.Predicted_Churn === 1 ? 'Churn' : 'Stay'"></span>
                                                    </td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="(record.Probability * 100).toFixed(2) + '%'"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="record.Actual_Churn"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-500" x-text="record.prediction_timestamp || record.prediction_time"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Statistics Tab -->
                            <div x-show="activeTab === 'statistics'">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-semibold text-gray-800">Dataset Statistics Summary</h4>
                                    <button 
                                        @click="downloadData()"
                                        class="px-3 py-1 bg-gray-900 text-white text-sm rounded hover:bg-gray-800">
                                        Download CSV
                                    </button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Field</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Count</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unique</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Top Value</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Frequency</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="stat in statisticsData" :key="stat.field">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="stat.field"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="stat.count"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="stat.unique"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="stat.top_value"></td>
                                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="stat.frequency"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Customer Search Tab -->
                            <div x-show="activeTab === 'search'">
                                <div class="mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">Search Customers</h4>
                                    
                                    <!-- Search Form -->
                                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Search Query</label>
                                                <input 
                                                    type="text" 
                                                    x-model="searchForm.query"
                                                    placeholder="Enter search term..."
                                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Search Field</label>
                                                <select 
                                                    x-model="searchForm.field"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                                                    <option value="all">All Fields</option>
                                                    <option value="customerID">Customer ID</option>
                                                    <option value="gender">Gender</option>
                                                    <option value="Contract">Contract</option>
                                                    <option value="PaymentMethod">Payment Method</option>
                                                    <option value="InternetService">Internet Service</option>
                                                    <option value="Churn">Churn Status</option>
                                                </select>
                                            </div>
                                            <div class="flex items-end">
                                                <button 
                                                    @click="searchCustomers()"
                                                    :disabled="searchLoading"
                                                    class="w-full px-4 py-2 bg-gray-900 text-white rounded hover:bg-gray-800 disabled:opacity-50">
                                                    <span x-show="!searchLoading">Search</span>
                                                    <span x-show="searchLoading">Searching...</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Search Results -->
                                    <div x-show="searchResults.length > 0">
                                        <div class="flex justify-between items-center mb-3">
                                            <div class="text-sm text-gray-600">
                                                Showing <span x-text="searchResults.length"></span> of <span x-text="searchTotalFound"></span> results
                                            </div>
                                            <button 
                                                @click="downloadSearchResults()"
                                                class="px-3 py-1 bg-gray-900 text-white text-sm rounded hover:bg-gray-800">
                                                Download Results
                                            </button>
                                        </div>
                                        
                                        <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50 sticky top-0">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer ID</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Gender</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Contract</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monthly Charges</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total Charges</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Churn</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200">
                                                    <template x-for="customer in searchResults" :key="customer.customerID">
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="px-3 py-2 text-sm font-medium text-gray-900" x-text="customer.customerID"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="customer.gender"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="customer.Contract"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="parseFloat(customer.MonthlyCharges).toFixed(2)"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="parseFloat(customer.TotalCharges).toFixed(2)"></td>
                                                            <td class="px-3 py-2 text-sm">
                                                                <span :class="customer.Churn === 'Yes' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                                                      class="px-2 py-1 rounded-full text-xs font-medium" x-text="customer.Churn"></span>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- No Results Message -->
                                    <div x-show="searchPerformed && searchResults.length === 0" class="text-center py-8 text-gray-500">
                                        No customers found matching your search criteria.
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics Charts Tab -->
                            <div x-show="activeTab === 'charts'">
                                <div class="mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">Analytics Charts from Storm Topology</h4>
                                    
                                    <div x-show="charts.length === 0" class="text-center py-8 text-gray-500">
                                        Loading charts...
                                    </div>
                                    
                                    <div x-show="charts.length > 0" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <template x-for="chart in charts" :key="chart.filename">
                                            <div class="bg-white rounded-lg simple-border p-4">
                                                <h5 class="font-semibold text-gray-800 mb-3" x-text="chart.title"></h5>
                                                <div class="flex justify-center">
                                                    <img :src="chart.url" :alt="chart.title" 
                                                         class="max-w-full h-auto rounded shadow-sm"
                                                         style="max-height: 400px;">
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Filter Tab -->
                            <div x-show="activeTab === 'filter'">
                                <div class="mb-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">Advanced Customer Filter</h4>
                                    
                                    <!-- Filter Form -->
                                    <div class="bg-gray-50 p-6 rounded-lg mb-4">
                                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                            <!-- Gender Filter -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                                <select x-model="filterForm.filters.gender" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                                    <option value="">All</option>
                                                    <option value="Male">Male</option>
                                                    <option value="Female">Female</option>
                                                </select>
                                            </div>

                                            <!-- Senior Citizen Filter -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Senior Citizen</label>
                                                <select x-model="filterForm.filters.senior_citizen" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                                    <option value="">All</option>
                                                    <option value="0">No</option>
                                                    <option value="1">Yes</option>
                                                </select>
                                            </div>

                                            <!-- Contract Filter -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Contract</label>
                                                <select x-model="filterForm.filters.contract" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                                    <option value="">All</option>
                                                    <option value="Month-to-month">Month-to-month</option>
                                                    <option value="One year">One year</option>
                                                    <option value="Two year">Two year</option>
                                                </select>
                                            </div>

                                            <!-- Internet Service Filter -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Internet Service</label>
                                                <select x-model="filterForm.filters.internet_service" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                                    <option value="">All</option>
                                                    <option value="DSL">DSL</option>
                                                    <option value="Fiber optic">Fiber optic</option>
                                                    <option value="No">No</option>
                                                </select>
                                            </div>

                                            <!-- Churn Filter -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Churn Status</label>
                                                <select x-model="filterForm.filters.churn" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                                    <option value="">All</option>
                                                    <option value="Yes">Yes</option>
                                                    <option value="No">No</option>
                                                </select>
                                            </div>

                                            <!-- Monthly Charges Range -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Charges (Min)</label>
                                                <input type="number" x-model="filterForm.filters.monthly_charges_min" 
                                                       placeholder="0" step="0.01" min="0" max="200"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Charges (Max)</label>
                                                <input type="number" x-model="filterForm.filters.monthly_charges_max" 
                                                       placeholder="200" step="0.01" min="0" max="200"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                            </div>

                                            <!-- Tenure Range -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">Tenure (Min months)</label>
                                                <input type="number" x-model="filterForm.filters.tenure_min" 
                                                       placeholder="0" min="0" max="72"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-gray-500">
                                            </div>
                                        </div>

                                        <div class="mt-4 flex justify-between">
                                            <button @click="clearFilters()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
                                                Clear Filters
                                            </button>
                                            <button @click="applyFilters()" :disabled="filterLoading" 
                                                    class="px-6 py-2 bg-gray-900 text-white rounded hover:bg-gray-800 disabled:opacity-50">
                                                <span x-show="!filterLoading">Apply Filters</span>
                                                <span x-show="filterLoading">Filtering...</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Filter Summary -->
                                    <div x-show="filterSummary" class="bg-blue-50 p-4 rounded-lg mb-4">
                                        <h5 class="font-semibold text-blue-800 mb-2">Filter Results Summary</h5>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                            <div>
                                                <span class="text-blue-600">Total Found:</span>
                                                <span class="font-semibold" x-text="filterSummary.total_found"></span>
                                            </div>
                                            <div>
                                                <span class="text-blue-600">Churn Rate:</span>
                                                <span class="font-semibold" x-text="filterSummary.churn_rate + '%'"></span>
                                            </div>
                                            <div>
                                                <span class="text-blue-600">Avg Monthly:</span>
                                                <span class="font-semibold" x-text="'$' + filterSummary.avg_monthly_charges"></span>
                                            </div>
                                            <div>
                                                <span class="text-blue-600">Avg Total:</span>
                                                <span class="font-semibold" x-text="'$' + filterSummary.avg_total_charges"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Filter Results -->
                                    <div x-show="filterResults.length > 0">
                                        <div class="flex justify-between items-center mb-3">
                                            <div class="text-sm text-gray-600">
                                                Showing <span x-text="filterResults.length"></span> of <span x-text="filterSummary.total_found"></span> filtered results
                                            </div>
                                            <button @click="downloadFilterResults()" 
                                                    class="px-3 py-1 bg-gray-900 text-white text-sm rounded hover:bg-gray-800">
                                                Download Results
                                            </button>
                                        </div>
                                        
                                        <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50 sticky top-0">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer ID</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Gender</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Contract</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tenure</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Monthly</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Churn</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-200">
                                                    <template x-for="customer in filterResults" :key="customer.customerID">
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="px-3 py-2 text-sm font-medium text-gray-900" x-text="customer.customerID"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="customer.gender"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="customer.Contract"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="customer.tenure + ' months'"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="'$' + parseFloat(customer.MonthlyCharges).toFixed(2)"></td>
                                                            <td class="px-3 py-2 text-sm text-gray-600" x-text="'$' + parseFloat(customer.TotalCharges).toFixed(2)"></td>
                                                            <td class="px-3 py-2 text-sm">
                                                                <span :class="customer.Churn === 'Yes' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                                                      class="px-2 py-1 rounded-full text-xs font-medium" x-text="customer.Churn"></span>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- No Filter Results Message -->
                                    <div x-show="filterPerformed && filterResults.length === 0" class="text-center py-8 text-gray-500">
                                        No customers found matching your filter criteria.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        function churnApp() {
            return {
                // Data properties
                form: {
                    total_charges: '',
                    monthly_charges: ''
                },
                predictionResult: null,
                loading: false,
                stats: {
                    total_processed: 0,
                    total_predictions: 0,
                    churn_rate: 0,
                    accuracy: 80.0
                },
                processedData: [],
                predictionsData: [],
                statisticsData: [],
                searchResults: [],
                searchForm: {
                    query: '',
                    field: 'all',
                    limit: 50
                },
                searchLoading: false,
                searchPerformed: false,
                searchTotalFound: 0,
                charts: [],
                filterForm: {
                    filters: {
                        gender: '',
                        senior_citizen: '',
                        contract: '',
                        internet_service: '',
                        churn: '',
                        monthly_charges_min: '',
                        monthly_charges_max: '',
                        total_charges_min: '',
                        total_charges_max: '',
                        tenure_min: '',
                        tenure_max: ''
                    },
                    limit: 100
                },
                filterResults: [],
                filterSummary: null,
                filterLoading: false,
                filterPerformed: false,
                activeTab: 'processed',
                autoRefresh: true,
                lastUpdated: null,
                refreshInterval: null,

                // Initialize
                init() {
                    this.loadStats();
                    this.refreshData();
                    this.loadStatistics();
                    this.loadCharts();
                    this.startAutoRefresh();
                },

                // Make prediction
                async makePrediction() {
                    this.loading = true;
                    
                    try {
                        const response = await fetch('/api/predict', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.form)
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            this.predictionResult = data;
                            
                            // Refresh data after prediction
                            setTimeout(() => {
                                this.refreshData();
                                this.loadStats();
                            }, 1000);
                        } else {
                            alert('Lỗi: ' + data.error);
                        }
                    } catch (error) {
                        alert('Lỗi kết nối: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                // Load statistics
                async loadStats() {
                    try {
                        const response = await fetch('/api/stats');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.stats = data.stats;
                        }
                    } catch (error) {
                        console.error('Error loading stats:', error);
                    }
                },

                // Refresh data
                async refreshData() {
                    await Promise.all([
                        this.loadProcessedData(),
                        this.loadPredictionsData()
                    ]);
                    this.lastUpdated = new Date().toLocaleTimeString();
                },

                // Load processed data
                async loadProcessedData() {
                    try {
                        const response = await fetch('/api/data/processed');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.processedData = data.data.reverse(); // Show latest first
                        }
                    } catch (error) {
                        console.error('Error loading processed data:', error);
                    }
                },

                // Load predictions data
                async loadPredictionsData() {
                    try {
                        const response = await fetch('/api/data/predictions');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.predictionsData = data.data.reverse(); // Show latest first
                        }
                    } catch (error) {
                        console.error('Error loading predictions data:', error);
                    }
                },

                // Start auto refresh
                startAutoRefresh() {
                    this.refreshInterval = setInterval(() => {
                        if (this.autoRefresh) {
                            this.refreshData();
                            this.loadStats();
                        }
                    }, 5000); // Refresh every 5 seconds
                },

                // Load statistics data
                async loadStatistics() {
                    try {
                        const response = await fetch('/api/statistics');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.statisticsData = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading statistics:', error);
                    }
                },

                // Search customers
                async searchCustomers() {
                    this.searchLoading = true;
                    this.searchPerformed = true;
                    
                    try {
                        const response = await fetch('/api/search_customers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.searchForm)
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            this.searchResults = data.data;
                            this.searchTotalFound = data.total_found;
                        } else {
                            alert('Search error: ' + data.error);
                            this.searchResults = [];
                            this.searchTotalFound = 0;
                        }
                    } catch (error) {
                        alert('Connection error: ' + error.message);
                        this.searchResults = [];
                        this.searchTotalFound = 0;
                    } finally {
                        this.searchLoading = false;
                    }
                },

                // Download search results
                downloadSearchResults() {
                    window.open('/download/search_results', '_blank');
                },

                // Load charts
                async loadCharts() {
                    try {
                        const response = await fetch('/api/charts');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.charts = data.charts;
                        }
                    } catch (error) {
                        console.error('Error loading charts:', error);
                    }
                },

                // Apply filters
                async applyFilters() {
                    this.filterLoading = true;
                    this.filterPerformed = true;
                    
                    try {
                        const response = await fetch('/api/filter_customers', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.filterForm)
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            this.filterResults = data.data;
                            this.filterSummary = data.summary;
                        } else {
                            alert('Filter error: ' + data.error);
                            this.filterResults = [];
                            this.filterSummary = null;
                        }
                    } catch (error) {
                        alert('Connection error: ' + error.message);
                        this.filterResults = [];
                        this.filterSummary = null;
                    } finally {
                        this.filterLoading = false;
                    }
                },

                // Clear filters
                clearFilters() {
                    this.filterForm.filters = {
                        gender: '',
                        senior_citizen: '',
                        contract: '',
                        internet_service: '',
                        churn: '',
                        monthly_charges_min: '',
                        monthly_charges_max: '',
                        total_charges_min: '',
                        total_charges_max: '',
                        tenure_min: '',
                        tenure_max: ''
                    };
                    this.filterResults = [];
                    this.filterSummary = null;
                    this.filterPerformed = false;
                },

                // Download filter results
                downloadFilterResults() {
                    // Create CSV content from filter results
                    if (this.filterResults.length === 0) {
                        alert('No data to download');
                        return;
                    }
                    
                    const headers = Object.keys(this.filterResults[0]);
                    const csvContent = [
                        headers.join(','),
                        ...this.filterResults.map(row => 
                            headers.map(header => 
                                typeof row[header] === 'string' && row[header].includes(',') 
                                    ? `"${row[header]}"` 
                                    : row[header]
                            ).join(',')
                        )
                    ].join('\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'filtered_customers.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                },

                // Download data
                downloadData() {
                    let dataType;
                    if (this.activeTab === 'processed') {
                        dataType = 'processed';
                    } else if (this.activeTab === 'predictions') {
                        dataType = 'predictions';
                    } else if (this.activeTab === 'statistics') {
                        dataType = 'statistics';
                    } else {
                        dataType = 'customer_data';
                    }
                    window.open(`/download/${dataType}`, '_blank');
                }
            }
        }
    </script>
</body>
</html> 